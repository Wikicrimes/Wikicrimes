<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:v="urn:schemas-microsoft-com:vml">
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<title></title>

	<script	src="http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAg4v-Pz31X7RpxlFPsEIYsRTazo9qQMtEEaWMpOq8Zpopb9nT3RT_PrvaAoazyXGxX2pPie38TEPKIQ"type="text/javascript">
	</script>
	<script src="scripts/greversegeocoder.js" type="text/javascript">
	</script>
	
	<script type="text/javascript">

		var reversegeocoder = null;
		var map;
		var i;
		var pontos;
		var marker;
		var pontoNoMapa;
		
		function initialize() {
			if (GBrowserIsCompatible()) {
				map = new GMap2(document.getElementById("map_canvas"));
				map.setCenter(new GLatLng(0, 0), 1);
				map.addControl(new GLargeMapControl());
		 		map.addControl(new GMapTypeControl());
		  		map.addControl(new GScaleControl());
		 		map.addControl(new GOverviewMapControl());
		 		map.enableScrollWheelZoom();
			}
		}

		function iniciarBusca(pontosSelecionados) {
			i = 0;
			pontos = pontosSelecionados
			processarReverse();
		}
		
		//Busca os dados de endereço de cada ponto.
		function processarReverse() {
			
			if (i < pontos.length) {

				if (reversegeocoder != null)
					GEvent.clearInstanceListeners(reversegeocoder);
				reversegeocoder = new GReverseGeocoder(map);
				
				//Evento que é chamado quando a requisição dos endereços é respondida 
				GEvent.addListener(reversegeocoder, "load", function(placemark) {
					
					pontos[i].cep = reversegeocoder.getPlacemarkProperty(placemark,"PostalCodeNumber");
					pontos[i].endereco = reversegeocoder.getPlacemarkProperty(placemark,"ThoroughfareName");  
					pontos[i].cidade = reversegeocoder.getPlacemarkProperty(placemark,"LocalityName");  
		
					if (reversegeocoder.getPlacemarkProperty(placemark,"AdministrativeAreaName")) 
						pontos[i].estado = reversegeocoder.getPlacemarkProperty(placemark,"AdministrativeAreaName");  					      					    
					else     
						pontos[i].estado = reversegeocoder.getPlacemarkProperty(placemark,"SubAdministrativeAreaName");
					
					pontos[i].pais = reversegeocoder.getPlacemarkProperty(placemark,"CountryNameCode");

					
					if (++i < pontos.length)
						processarReverse();
					else {
						analisarResultado();
						parent.submit(criarStringPontoss());
					}
				});
				
				//Evento que é chamado quando a requisição dos endereços não é corretamente respondida
				GEvent.addListener(reversegeocoder, "error", function() {

					if (++i < pontos.length)
						processarReverse();
					else {
						analisarResultado();
						parent.submit(criarStringPontoss());
					}
				});

				//Realiza uma requisição reverseGeocoder do proximo ponto do vetor 'pontos'
				reversegeocoder.reverseGeocode(new GLatLng(pontos[i].lat,pontos[i].lng));
			}
		}

		//Gera String que será enviada para o backBean pela pagina pai;
		function criarStringPontoss() {
			var stringPonto = '';
			for ( var j = 0; j < pontos.length; j++) {
				stringPonto += pontos[j].id + ";";
				stringPonto += pontos[j].pais + ";";
				stringPonto += pontos[j].estado + ";";
				stringPonto += pontos[j].cidade + ";";
				stringPonto += pontos[j].endereco + ";";
				stringPonto += pontos[j].cep + ";";
			}
			stringPonto = '' + stringPonto;
			return stringPonto;
		}
		
		//Analiza o resultado de processarReverse e muda a string de resposta ao usuário na página pai
		function analisarResultado() {
			var todoCorreto = true;
			var todoIncorreto = true;
			
			for ( var j = 0; j < pontos.length; j++) {
				if(pontos[j].pais == undefined)
					todoCorreto = false;
				else
					todoIncorreto = false;
			}
			
			if(todoCorreto)
				parent.msgAtualizacao = parent.atualizacaoTotal;
			else if(todoIncorreto)
				parent.msgAtualizacao = parent.atualizacaoNaoEfetuada;
			else
				parent.msgAtualizacao = parent.atualizacaoParcial;
		}


		
		
		/*
			-- Sessão "pontosNaoEncontrados.jspx" --
		*/
		
		
		//Adiciona um Marker e seus eventos ao map.
		function fixarTarrachaPonto(pontoAux) {
			pontoNoMapa = pontoAux;

			lat = pontoNoMapa.lat; 
			lng = pontoNoMapa.lng;
			
			var centro = new GLatLng(lat,lng);

			if(marker)
				map.removeOverlay(marker);
			
			marker = new GMarker(centro, {draggable: true});
			
			map.addOverlay(marker);
			map.setCenter(centro, 14);

			GEvent.addListener(marker, "dragstart", function() {
				marker.closeInfoWindow();
				parent.iniciarForm(pontoNoMapa);
		    });

		    GEvent.addListener(marker, "dragend", function() {
		    	marker.openInfoWindowHtml("<html><head></head><body><p align='center'>"+
		    	    	"<input type='button' onclick='procurarEndereco();' value='"+parent.textoBotaoReverse+"' />"+
		    	    	"</body></html>");
		    });
		}

		//Usa o reverse geocoder para procurar dados do endereço
		function procurarEndereco() {

				if (reversegeocoder)
					GEvent.clearInstanceListeners(reversegeocoder);
				reversegeocoder = new GReverseGeocoder(map);
				
				//Evento que é chamado quando a requisição dos endereços é respondida 
				GEvent.addListener(reversegeocoder, "load", function(placemark) {

					pontoNoMapa.cep = reversegeocoder.getPlacemarkProperty(placemark,"PostalCodeNumber");
					pontoNoMapa.endereco = reversegeocoder.getPlacemarkProperty(placemark,"ThoroughfareName");  
					pontoNoMapa.cidade = reversegeocoder.getPlacemarkProperty(placemark,"LocalityName");  

					if (reversegeocoder.getPlacemarkProperty(placemark,"AdministrativeAreaName")) 
						pontoNoMapa.estado = reversegeocoder.getPlacemarkProperty(placemark,"AdministrativeAreaName");  					      					    
					else     
						pontoNoMapa.estado = reversegeocoder.getPlacemarkProperty(placemark,"SubAdministrativeAreaName");
					
					pontoNoMapa.pais = reversegeocoder.getPlacemarkProperty(placemark,"CountryNameCode");
					var latlngAux = marker.getLatLng();
					pontoNoMapa.lat = latlngAux.lat();
					pontoNoMapa.lng = latlngAux.lng();

					parent.document.getElementById("idAuxForm").value = pontoNoMapa.id;
					parent.document.getElementById("idForm").value = pontoNoMapa.id;
					parent.document.getElementById("paisForm").value = pontoNoMapa.pais;
					parent.document.getElementById("estadoForm").value = pontoNoMapa.estado;
					parent.document.getElementById("cidadeForm").value = pontoNoMapa.cidade;
					parent.document.getElementById("enderecoForm").value = pontoNoMapa.endereco;
					parent.document.getElementById("cepForm").value = pontoNoMapa.cep;
					parent.document.getElementById("latForm").value = pontoNoMapa.lat;
					parent.document.getElementById("lngForm").value = pontoNoMapa.lng;
				});
				
				//Evento que é chamado quando a requisição dos endereços não é corretamente respondida
				GEvent.addListener(reversegeocoder, "error", function() {
					alert(parent.msgDeErro);
				});

				//Realiza a requisição reverseGeocoder do ponto em foco
				var latlng = marker.getLatLng();
				reversegeocoder.reverseGeocode(latlng);
		}
	</script>
</head>

<body onload="initialize()" onunload="GUnload()">
	<div id="map_canvas" style="width: 500px; height: 350px"></div>
</body>
</html>
